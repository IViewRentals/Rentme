/*
 * 功能：    拓展String类型方法，添加常用功能
 * 创建人：  焰尾迭
 * 创建时间：2015-11-18
 */
$.extend(String.prototype,{format:function(e){var t=this;if(arguments.length>0)if(1==arguments.length&&"object"==typeof e){for(var s in e)if(void 0!=e[s]){var a=new RegExp("({"+s+"})","g");t=t.replace(a,e[s])}}else for(var i=0;i<arguments.length;i++)if(void 0!=arguments[i]){var a=new RegExp("({)"+i+"(})","g");t=t.replace(a,arguments[i])}return t}}),/*!
 @Name：fiterMore v1.0 互联网风格筛选条件插件
 @Author：焰尾迭
 @Site：http://yanwei.cnblogs.com
 @github: http://aui.github.com/fiterMore
 @License：LGPL
 */
function(e){e.fn.extend({fiterMore:function(t){function s(){var t="";e(_.searchBoxs).each(function(e,s){t+='<div class="searchbox-item" {0} data-id="{1}" id="{2}">'.format(e+1==_.searchBoxs.length?'style="border: 0"':"",e,s.id)+'<div class="l" id="{1}_l">{0}<i></i></div>'.format(s.title,s.id)+'<div class="c" id="{0}_c">'.format(s.id)+'<div class="control-type">({0})</div><div class="filter_option" style="padding-right:{1}px;">'.format(s.isMultiple?"多选":"单选",a(s)+20)+i(s)+"</div>"+l(e,s)+"</div>"+'<a href="javascript:;" class="r" id="{0}_r"><span class="text">展开</span></a>'.format(s.id)+"</div>"}),m.html(t),e(".searchbox .searchbox-item").each(function(t){var s=e(this).find(".filter_option").outerHeight();s<=30&&e(this).find(".r").remove()}),_.expandRow<_.searchBoxs.length&&m.after(x)}function a(e){return e.custom?1==e.custom.isRange?"date"==e.type?320:"datetime"==e.type?440:260:"date"==e.type?200:"datetime"==e.type?260:170:0}function i(t){var s="";(t.isMultiple||!t.isMultiple&&t.isShowAll)&&(s='<span title="全部" class="option_all {0}">全部</span>'.format(t.defaults&&0!=t.defaults.length?"":"selected"));var a=r(t),i=h;if(a&&!isNaN(t.expand.max)){var l=parseInt(t.expand.max,10);i=i>l?l:i}return e(t.data).each(function(l,n){a&&1+l>i||(s+='<span title="{0}" data-id="{1}" data-value="{3}" {2}>{0}</span>'.format(n[t.textField],l,e.inArray(n[t.valueField],t.defaults)>=0?"class='selected'":"",n[t.valueField]))}),s}function l(e,t){if(t.custom){var s="70px";"date"==t.type?s="100px":"datetime"==t.type&&(s="160px");var i='<div class="filter_custom" style="width:{0}px;"><span>自定义</span>'.format(a(t));return i+='<span><input type="text" id="{0}_c_custom_start" style="width:{1};"></span>'.format(t.id,s),t.custom.isRange&&(i+="<span>—</span>"+'<span><input type="text" id="{0}_c_custom_end" {1}></span>'.format(t.id,s?"style='width:{0}'".format(s):"")),i+='<span class="btn_filter_sure" data-id="{0}">确定</span></div>'.format(e)}return""}function n(t){return e(t).closest(".searchbox-item").attr("data-id")}function c(e){var t=n(e);return _.searchBoxs[t]}function o(){var t=[],s=null;return e(_.searchBoxs).each(function(e,a){s={},a.customSelectd.length>0?s[_.paramCustomkey]=a.customSelectd:s[_.paramkey]=a.selected,s.isMultiple=a.isMultiple,s.id=a.srcID,t.push(s)}),t}function r(e){return e.expand&&"function"==typeof e.expand.event}function d(t,s,a){function i(t){var s=e(t).find(".text");return"展开"==s.text()?"expand":"collaspe"}t.cancelBubble=!0;var l=i(s);if(!a||a!=l){var n=e(s).siblings(".c");if("expand"==l?(e(s).find(".text").text("收缩"),e(s).siblings(".c").css({height:"auto"})):(e(s).find(".text").text("展开"),n.css({height:30})),"展开条件"==x.find("span").text()){var o=0,d=0;e(".searchbox-item").each(function(t,s){"收缩"==e(s).find(".text").text()&&(o++,d+=e(s).find(".c").height())});var u=40*(_.expandRow-o)+9*o+d;0==o&&(u=y),m.css({height:u})}var f=c(s);r(f)&&f.expand.event(f.data,s,l)}}function u(t){t.custom&&t.customSelectd.length>0&&(t.customSelectd=[],e("#{0}_c_custom_start".format(t.id)).val(""),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(""))}function f(t){t.custom&&t.customSelectd.length>0&&(e("#{0}_c_custom_start".format(t.id)).val(t.customSelectd[0]),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(t.customSelectd[1]))}function p(t){function s(e,t){if(0==t.defaults.length)e.filter(".option_all").addClass("selected");else for(var s=0;s<t.defaults.length;s++)e.filter("[data-value='{0}']".format(t.defaults[s])).addClass("selected"),t.selected.push(t.defaults[s])}if(e.isArray(t)){for(var a={},i=null,l=0,n=t.length;l<n;l++)i=t[l],a[i.id]=i;var c;e(_.searchBoxs).each(function(t,l){if(i=a[l.srcID],c=e("#"+l.id).find(".filter_option span"),c.removeClass("selected"),u(l),l.selected=[],i){var n=i[_.paramkey],o=i[_.paramCustomkey];if(n&&n.length>0)for(var t=0;t<n.length&&(c.filter("[data-value='{0}']".format(n[t])).addClass("selected"),l.selected.push(n[t]),l.isMultiple);t++);else if(o&&o.length>0){for(var t=0;t<o.length;t++)l.customSelectd.push(o[t]);f(l)}else s(c,l)}else s(c,l)})}}var h=10,v="searchitem_",m=this,x=e('<div class="filter_btn"><span class="expand">展开条件</span></div>'),g={expandEvent:function(e){},expandRow:2,searchBoxs:[],search:function(e){},paramkey:"ValueList",paramCustomkey:"CustomList",searchOnSelect:!0},_=e.extend(g,t);if(isNaN(_.expandRow)||_.expandRow<1)throw Error("默认展开条件数'expandRow'必须为大于0的整数");_.expandRow>_.searchBoxs.length&&(_.expandRow=_.searchBoxs.length);var y=40*_.expandRow-1*(_.expandRow-1);return m.css({height:y}),e(_.searchBoxs).each(function(e,t){t.id&&"string"==typeof t.id?(t.srcID=t.id,t.id="{0}{1}".format(v,t.id)):(t.srcID=e,t.id="{0}{1}".format(v,e)),t.valueField||t.textField?(t.valueField&&!t.textField&&(t.textField=t.valueField),t.textField&&!t.valueField&&(t.valueField=t.textField)):(t.valueField="value",t.textField="text"),t.defaults||(t.defaults=[]),t.selected=[];for(var s=0;s<t.defaults.length;s++)t.selected.push(t.defaults[s]);t.customSelectd=[],void 0==t.isMultiple&&(t.isMultiple=!1),void 0==t.isShowAll&&(t.isShowAll=!0)}),s(),m.on("click select",".filter_option span",function(t){var s=c(this),a=e(this).attr("data-id"),i="select";if(0==s.isMultiple||e(this).hasClass("option_all"))e(this).addClass("selected").siblings("span").removeClass("selected"),s.selected=[],e(this).hasClass("option_all")?i="cancelall":(s.selected.push(s.data[a][s.valueField]),i="selectremove");else if(e(this).hasClass("selected")){e(this).removeClass("selected"),i="cancel";for(var l=s.data[a][s.valueField],n=0,r=s.selected.length;n<r;n++)s.selected[n]==l&&s.selected.splice(n,1);0==s.selected.length&&(e(this).siblings(".option_all").addClass("selected"),i="cancelall")}else e(this).addClass("selected"),e(this).siblings(".option_all").removeClass("selected"),s.selected.push(s.data[a][s.valueField]),i="select";u(s),"function"==typeof s.onSelect&&"click"==t.type&&s.onSelect(s.data[a],i),"function"==typeof _.search&&_.searchOnSelect&&_.search(o())}),m.on("click",".r",function(e,t){d(e,this,t)}),x.find("span").on("click",function(){var t=!0;e(this).hasClass("expand")?(e(this).text("收缩条件").removeClass("expand"),m.css({height:"auto"})):(e(this).text("展开条件").addClass("expand"),m.css({height:y}),t=!1),"function"==typeof _.expandEvent&&_.expandEvent(t)}),m.on("click",".filter_custom .btn_filter_sure",function(){var t,s=e(this).attr("data-id"),a=_.searchBoxs[s],i=e("#{0}_c_custom_start".format(a.id)).val();a.custom.isRange&&(t=e("#{0}_c_custom_end".format(a.id)).val()),("function"!=typeof a.custom.event||a.custom.event(i,t))&&(e(this).closest(".filter_custom").siblings(".filter_option").find("span").removeClass("selected"),a.selected=[],a.customSelectd[0]=i,a.custom.isRange&&(a.customSelectd[1]=t),"function"==typeof _.search&&_.search(o()))}),m.each(function(){this.getParamList=o,this.setValue=p,this.isFiterMore=!0})},getParamList:function(){var e=this[0];if(e.isFiterMore)return e.getParamList()},searchFunctionCall:function(t){if(e.isPlainObject(t)){var s=this[0];if(s.isFiterMore)for(var a in t)return e.isFunction(s[a])?s[a](t[a]):(console.error("查询插件fiterMore不支持“{0}”方法".format(a)),null)}}})}(jQuery);